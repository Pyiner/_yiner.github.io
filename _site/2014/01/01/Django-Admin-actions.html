<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/tomorrow-night.css" media="screen" />
    <script src="/javascripts/highlight.pack.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Django Admin actions</title>
    <script>
        hljs.tabReplace = '';
        hljs.initHighlightingOnLoad();
    </script>

  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Yiner in Python</h1>
        </header>


        <hr>

        <section id="main_content">
            <p>使用一个函数对选中的条路做统一的改变。 三个参数：</p>

<ul>
<li>The current ModelAdmin</li>

<li>An HttpRequest representing the current request,</li>

<li>A QuerySet containing the set of objects selected by the user.</li>
</ul>
<hr />
<pre><code>from django.db import models

STATUS_CHOICES = (
    ('d', 'Draft'),
    ('p', 'Published'),
    ('w', 'Withdrawn'),)

class Article(models.Model):
    title = models.CharField(max_length=100)
    body = models.TextField()
    status = models.CharField(max_length=1, choices=STATUS_CHOICES)

    # On Python 3: def __str__(self):
    def __unicode__(self):
        return self.title
from django.contrib import adminfrom myapp.models import Article

def make_published(modeladmin, request, queryset):
    queryset.update(status='p')make_published.short_description = &quot;Mark selected stories as published&quot;

class ArticleAdmin(admin.ModelAdmin):
    list_display = ['title', 'status']
    ordering = ['title']
    actions = [make_published]

admin.site.register(Article, ArticleAdmin)      </code></pre>

<p>但是因为actions和这个Admin是紧耦合的，所以我们把这个函数当做方法卸载Admin内部</p>

<pre><code>actions = ['make_published']

def make_published(self, request, queryset):
    queryset.update(status='p')
make_published.short_description = &quot;Mark selected stories as published&quot;</code></pre>

<p>这里在actions中使用了字符串代替了上面的函数名，表示在make_published是方法。</p>

<p>使用self.message_user来对用户进行提示</p>

<p>使用action来提供一个中间页 直接返回一个响应</p>

<pre><code>from django.http import HttpResponsefrom django.core import serializers

def export_as_json(modeladmin, request, queryset):
	response = HttpResponse(content_type=&quot;application/json&quot;)
	serializers.serialize(&quot;json&quot;, queryset, stream=response)
	return response</code></pre>

<p>或者重定向</p>

<pre><code>from django.contrib import admin
from django.contrib.contenttypes.models import ContentType
from django.http import HttpResponseRedirect

def export_selected_objects(modeladmin, request, queryset):
    selected = request.POST.getlist(admin.ACTION_CHECKBOX_NAME)
    ct = ContentType.objects.get_for_model(queryset.model)
    return HttpResponseRedirect(&quot;/export/?ct=%s&amp;ids=%s&quot; % (ct.pk, &quot;,&quot;.join(selected)))</code></pre>

<p>将actions作用于全站,第二个参数是名字.</p>

<pre><code>admin.site.add_action(export_selected_objects, 'export_selected')</code></pre>

<p>禁用actions</p>

<pre><code>admin.site.disable_action('delete_selected')#禁用了自带的删除
admin.site.disable_action('delete_selected')                                                                                                       class SomeModelAdmin(admin.ModelAdmin):
    actions = ['some_other_action']
    ...

class AnotherModelAdmin(admin.ModelAdmin):
    actions = ['delete_selected', 'a_third_action']
    ...</code></pre>

<p>actuions只是ModelAdmin的一个字段,如果想禁用一个ModelAdmin的所有actions</p>

<pre><code>class MyModelAdmin(admin.ModelAdmin):
    actions = None</code></pre>

<p>如果想对用一个ModelAdmin下的不用字段或者同一字段对不用用户使用不同的actions,那么就覆盖掉get_actions方法.</p>

<p>返回一个允许的actions字典,keys是action的名字,value是一个(function,name,short_description)的元组.</p>

<pre><code>class MyModelAdmin(admin.ModelAdmin):
    ...

    def get_actions(self, request):
        actions = super(MyModelAdmin, self).get_actions(request)
        if request.user.username[0].upper() != 'J':
            if 'delete_selected' in actions:
                del actions['delete_selected']                                                                             return actions</code></pre>
        </section>

        <footer>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>
